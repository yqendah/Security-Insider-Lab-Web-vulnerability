<?php
ini_set("include_path", ".:etc/:../pages/");


include_once("etc/htb.inc");
include_once("etc/config.php");

session_set_cookie_params($htbconf['bank/cookievalidity']);
session_name($htbconf['bank/sid']);
session_start();

set_error_handler('errorHandler');
$link = new mysqli($htbconf['db/.server'], $htbconf['db/.login'], $htbconf['db/.pwd'], $htbconf['db/.name']) or die('Error connecting to database');

$username = $_REQUEST['username'];
$password = $_REQUEST['password'];
$hostname = $_SERVER['HTTP_HOST'];

// security measure 1

//if(!preg_match("/^[a-zA-Z0-9 ]*$/", $username) || !preg_match("/^[a-zA-Z0-9 ]*$/", $password))
//{
//	$_SESSION['warning'] = "<p>Only letters and white space allowed.</p><p>Please check your username or password</p>";
//	htb_redirect(htb_getbaseurl());
//	exit();
//}

// security measure 2

//$_SESSION['loggedin'] = false;
//try {
//    $stmt = $link->prepare("SELECT * FROM " . $htbconf['db/users'] . " where " . $htbconf['db/users.username'] . "=? and " . $htbconf['db/users.password'] . "=?");
//    $stmt->bind_param("ss", $username, $password);
////
//    $stmt->execute();
//    $stmt->store_result();
//    $stmt->bind_result($id, $pw, $uname, $name, $firstName, $time, $lastlogin, $lastlogIP);
//    $stmt->fetch();
//    if ($stmt->num_rows > 0) {
//        $_SESSION['loggedin'] = true;
//        $_SESSION['userid'] = $id;
//        $_SESSION['user'] = $uname;
//        $_SESSION['name'] = $name;
//        $_SESSION['firstname'] = $firstName;
//        $_SESSION['time'] = strtotime($time);
//        $_SESSION['lastlogin'] = strtotime($lastlogin);
//        $_SESSION['lastloginip'] = $lastlogIP;
//
//        $sql = "UPDATE " . $htbconf['db/users'] . " set " . $htbconf['db/users.lasttime'] . "=now(), " . $htbconf['db/users.lastip'] . "='" . $_SERVER['REMOTE_ADDR'] . "' where " . $htbconf['db/users.username'] . "='$username' and " . $htbconf['db/users.password'] . "='$password'";
//        if (!$link->multi_query($sql)) $_SESSION['warning'] .= "<p>Unable to update login time and login ip.</p><p>Please report this to your system administrator.</p>";
//        htb_redirect(htb_pageurl("htbmain"));
//
//    } else {
//        $_SESSION['error'] .= "<p>Your password or username is wrong!</p>";
//        htb_redirect(htb_getbaseurl());
//        exit();
//    }
//} catch (Exception $e) {
//    $_SESSION['warning'] = "<p>Something went wrong during your attempt to log in.</p><p>Please contact the system administrator</p>";
//    htb_redirect(htb_getbaseurl());
//    exit();
//}

//Security measure 3
//$username = $mysqli -> real_escape_string($_REQUEST['username']);
//$password = $mysqli -> real_escape_string($_REQUEST['password']);


$sql = "SELECT * FROM " . $htbconf['db/users'] . " where " . $htbconf['db/users.username'] . "='$username' and " . $htbconf['db/users.password'] . "='$password'";
// die($sql);
// var_dump($sql);
$_SESSION['loggedin'] = false;
if ($link->multi_query($sql)) {
	if ($result = $link->store_result()) {
		$row = $result->fetch_row();
		if ($row) {
			$_SESSION['loggedin'] = true;
			$_SESSION['userid'] = $row[0];
			$_SESSION['user'] = $row[2];
			$_SESSION['name'] = $row[3];
			$_SESSION['firstname'] = $row[4];
			$_SESSION['time'] = strtotime($row[5]);
			$_SESSION['lastlogin'] = strtotime($row[6]);
			$_SESSION['lastloginip'] = $row[7];
			$sql = "UPDATE " . $htbconf['db/users'] . " set " . $htbconf['db/users.lasttime'] . "=now(), " . $htbconf['db/users.lastip'] . "='" . $_SERVER['REMOTE_ADDR'] . "' where " . $htbconf['db/users.username'] . "='$username' and " . $htbconf['db/users.password'] . "='$password'";
			if (!$link->multi_query($sql)) $_SESSION['warning'].= "<p>Unable to update login time and login ip.</p><p>Please report this to your system administrator.</p>";
			htb_redirect(htb_pageurl("htbmain"));
		} else {
			$_SESSION['error'].= "<p>Your password or username is wrong!</p>";
			htb_redirect(htb_getbaseurl());
			exit();
		}
		$result->free();
	}
} else {
	$_SESSION['warning'] = "<p>Something went wrong during your attempt to log in.</p><p>Please contact the system administrator</p>";
	htb_redirect(htb_getbaseurl());
	exit();
}
$link->close();
?>
